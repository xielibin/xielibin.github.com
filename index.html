<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>天晷</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="天晷">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="天晷">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="天晷">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="天晷" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">天晷</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">脑容量有限，清理出来装灵感吧！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Bond-Chain调用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/29/Bond-Chain调用/" class="article-date">
  <time datetime="2016-03-29T08:04:30.000Z" itemprop="datePublished">2016-03-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/29/Bond-Chain调用/">Bond-Chain调用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在说明几个链式调用方法之前必须得明白链式调用的定义，如何实现链式调用。在Swift中Array里map、flatMap是满足链式调用的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let arr = [1, 2, 3]</span><br><span class="line">let res = arr.map &#123; (i) -&gt; String in</span><br><span class="line">    return &quot;\(i)&quot;</span><br><span class="line">    &#125; .map &#123; (index) -&gt; String in</span><br><span class="line">        return &quot;index:&quot; + index</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print(res)  //&quot;[&quot;index:1&quot;, &quot;index:2&quot;, &quot;index:3&quot;]\n&quot;</span><br></pre></td></tr></table></figure>
<p>大家请观摩 @唐巧 的烧脑体操（五）(<a href="http://www.infoq.com/cn/articles/swift-brain-gym-monad)里对链式调用实现的讲解。" target="_blank" rel="external">http://www.infoq.com/cn/articles/swift-brain-gym-monad)里对链式调用实现的讲解。</a></p>
<p><em>一定要先理解chain调用的原理，这个很重要，不然在swift的道路上往后走多少都将是徒劳，个人见解</em></p>
<p><em>同时补一句，目前烧脑体操系列出的其它节讲的内容也比较细致，前去观摩吧！！！</em></p>
<hr>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>实现代码在 protocol EventProducerType 的扩展里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/// Transformes each event by the given `transform` function.</span><br><span class="line">public func map&lt;T&gt;(transform: EventType -&gt; T) -&gt; EventProducer&lt;T&gt; &#123;</span><br><span class="line">  return EventProducer(replayLength: replayLength) &#123; sink in</span><br><span class="line">    return observe &#123; event in</span><br><span class="line">      sink(transform(event))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了对chain调用的理解，就知道目的是返回一个和调用着本身相同，只是Wrapped Value类型上的区别。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//   public typealias Sink = Event -&gt; Void  //是一个Func定义,作为回调</span><br><span class="line"></span><br><span class="line">public func map&lt;T&gt;(transform: EventType -&gt; T) -&gt; EventProducer&lt;T&gt; &#123;</span><br><span class="line">	var producer : (Sink -&gt; DisposableType?)?</span><br><span class="line"></span><br><span class="line">	producer = &#123; sink -&gt; DisposableType? in</span><br><span class="line">      	return self.observe &#123; event -&gt; Void in</span><br><span class="line">      		let transed = transform(event)</span><br><span class="line">        	sink(transed)</span><br><span class="line">      	&#125;</span><br><span class="line">	&#125; //此处注册一个观察者Block对象，当主题分发事件时，observer接收event, 调用transform转换，再回调sink</span><br><span class="line">	</span><br><span class="line">	return EventProducer(replayLength: self.replayLength, producer: producer) //lifecycle 是默认值 .Managed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析EventProducer init方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  public init(replayLength: Int = 0, lifecycle: EventProducerLifecycle = .Managed, @noescape producer: Sink -&gt; DisposableType?) &#123;</span><br><span class="line">    self.lifecycle = lifecycle  // ...</span><br><span class="line">    </span><br><span class="line">    let tmpSelfReference = Reference(self)</span><br><span class="line">    tmpSelfReference.release()</span><br><span class="line">    </span><br><span class="line">    if replayLength &gt; 0 &#123;</span><br><span class="line">      replayBuffer = Buffer(size: replayLength)</span><br><span class="line">    &#125;  // ...</span><br><span class="line">    </span><br><span class="line">    let disposable = producer &#123; event in</span><br><span class="line">      tmpSelfReference.object?.next(event)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if let disposable = disposable &#123;</span><br><span class="line">      deinitDisposable += disposable</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self.selfReference = tmpSelfReference</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let tmpSelfReference = Reference(self)</span><br><span class="line">tmpSelfReference.release()</span><br></pre></td></tr></table></figure>
<p>让对象本身成为无强引用，如果不再追加其它操作，后续会自动释放。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public final class Reference&lt;T: AnyObject&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  /// Encapsulated optional object.</span><br><span class="line">  public weak var object: T?</span><br><span class="line">  </span><br><span class="line">  /// Used to strongly reference (retain) encapsulated object.</span><br><span class="line">  private var strongReference: T?</span><br><span class="line">  </span><br><span class="line">  /// Creates the wrapper and strongly references the given object.</span><br><span class="line">  public init(_ object: T) &#123;</span><br><span class="line">    self.object = object</span><br><span class="line">    self.strongReference = object</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  /// Relinquishes strong reference to the object, but keeps weak one.</span><br><span class="line">  /// If object it not strongly referenced by anyone else, it will be deallocated.</span><br><span class="line">  public func release() &#123;</span><br><span class="line">    strongReference = nil</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  /// Re-establishes a strong reference to the object if it&apos;s still alive,</span><br><span class="line">  /// otherwise it doesn&apos;t do anything useful.</span><br><span class="line">  public func retain() &#123;</span><br><span class="line">    strongReference = object</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let disposable = producer &#123; event in</span><br><span class="line">  tmpSelfReference.object?.next(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var producerInit : (Sink -&gt; DisposableType?)?</span><br><span class="line">producerInit = producer</span><br><span class="line">let sink : (Event -&gt; Void) = &#123; Event -&gt; Void in</span><br><span class="line">	tmpSelfReference.object?.next(event)   //自己变成主题对象，在拿到事件后，分发事件</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">producerInit(sink)</span><br></pre></td></tr></table></figure>
<h5 id="事件流"><a href="#事件流" class="headerlink" title="事件流"></a>事件流</h5><p>1.存在的主要对象1 -&gt; 注册 观察对象1 ，观察对象1 -&gt; 持有对新建 主题对象2 的弱引用<br>2.主题对象1 分发事件，-&gt; 观察对象1 接收事件，-&gt; 主要对象1 将事件 转化成（EventType -&gt; T） 事件T ， -&gt; 观察对象1 传递事件T 给主题对象2， -&gt; 主题对象2 接收事件T， -&gt; next(T) 分发事件</p>
<h2 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h2><p>与map区别在于 transfrom(转化) 变成了 includeEvent(过滤)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if includeEvent(event) &#123;</span><br><span class="line">  sink(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主题对象1 分发的事件值 经过 includeEvent 计算满足条件 返回true 则 传递事件。 否则 停止流程。</p>
<h2 id="deliverOn"><a href="#deliverOn" class="headerlink" title="deliverOn"></a>deliverOn</h2><p>与map 区别 传入一个 Queue作为事件异步分发队列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queue.async &#123;</span><br><span class="line">  sink(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h2><p>正如名字一样作开头用处，和filter区别过滤条件 在于这个是关闭固定时间，然后分发最新一次事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public func throttle(seconds: Queue.TimeInterval, queue: Queue) -&gt; EventProducer&lt;EventType&gt; &#123;</span><br><span class="line">  return EventProducer(replayLength: replayLength) &#123; sink in</span><br><span class="line">    var shouldDispatch: Bool = true</span><br><span class="line">    var lastEvent: EventType! = nil</span><br><span class="line">    return observe &#123; event in</span><br><span class="line">      lastEvent = event</span><br><span class="line">      if shouldDispatch &#123;</span><br><span class="line">        shouldDispatch = false</span><br><span class="line">        queue.after(seconds) &#123;</span><br><span class="line">          sink(lastEvent)</span><br><span class="line">          lastEvent = nil</span><br><span class="line">          shouldDispatch = true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里定义了两个变量让 观察对象1 持有分别用于记录最新事件 lastEvent， 判定是否可以分发 shouldDispatch；并且此处是传入的Queue内分发。</p>
<h2 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h2><p>事发定义跳过多少次事件分发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public func skip(var count: Int) -&gt; EventProducer&lt;EventType&gt; &#123;</span><br><span class="line">  return EventProducer(replayLength: max(replayLength - count, 0)) &#123; sink in</span><br><span class="line">    return observe &#123; event in</span><br><span class="line">      if count &gt; 0 &#123;</span><br><span class="line">        count--</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        sink(event)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接将count参数申明为var 作为变量让 观察对象1 持有，记录跳过情况。</p>
<h2 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h2><p>定义一个必须要先分发一次的初始事件值，先sink一次。</p>
<h2 id="combineLatestWith"><a href="#combineLatestWith" class="headerlink" title="combineLatestWith"></a>combineLatestWith</h2><p>这是一个很为重要的功能，比如 可以合成多个条件来 最张决定 一个关口是否能够开启</p>
<p>常用例子：<br>名字 和 Email 都不能为空，将两个条件合成 作为判定 提交是否 enable。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public func combineLatestWith&lt;U: EventProducerType&gt;(other: U) -&gt; EventProducer&lt;(EventType, U.EventType)&gt; &#123;</span><br><span class="line">  return EventProducer(replayLength: min(replayLength + other.replayLength, 1)) &#123; sink in</span><br><span class="line">    var myEvent: EventType! = nil</span><br><span class="line">    var itsEvent: U.EventType! = nil</span><br><span class="line">    </span><br><span class="line">    let onBothNext = &#123; () -&gt; Void in</span><br><span class="line">      if let myEvent = myEvent, let itsEvent = itsEvent &#123;</span><br><span class="line">        sink((myEvent, itsEvent))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    let myDisposable = observe &#123; event in</span><br><span class="line">      myEvent = event</span><br><span class="line">      onBothNext()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    let itsDisposable = other.observe &#123; event in</span><br><span class="line">      itsEvent = event</span><br><span class="line">      onBothNext()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return CompositeDisposable([myDisposable, itsDisposable])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>定义两个变量 myEvent 和 itsEvent 作为存储最新事件值。</li>
<li>定义一个onBothNext 的 闭包 持有 两个变量， 并当两个变量都有值时 调用sink 触发事件分发。</li>
<li>注册自己的 观察闭包对象 赋值新值 调用onBothNext</li>
<li>注册要合成的 另一个主题对象 的 观察闭包对象  赋值新值 调用onBothNext</li>
</ol>
<h3 id="flatMap-reduce"><a href="#flatMap-reduce" class="headerlink" title="flatMap reduce"></a>flatMap reduce</h3><p>这两个功能是放在最后的，目前没发现太好的运用场景。<br><em>说明：这里在说库中Array的用法 </em><br>在库Array里这两个功能的运用场景还是非常强大的， flatMap 会将 nil 过虑掉； reduce 求和较为方便</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/29/Bond-Chain调用/" data-id="cimd8jb650000tkzlqk570n15" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Revel-run干了什么？" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/28/Revel-run干了什么？/" class="article-date">
  <time datetime="2016-03-28T13:13:11.000Z" itemprop="datePublished">2016-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/28/Revel-run干了什么？/">Revel-run干了什么？</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>revel run 命令调用执行主要代码位于/revel/cmd/revel/run.go。</p>
<p>运行命令的方式：revel run github.com/revel/samples/chat prod 8080<code>，和new一样revel命令会对运行参数进行进行最后将run后面的参数提取出来作为调用</code>func runApp(args []string)`的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if len(args) == 0 &#123;</span><br><span class="line">	errorf(&quot;No import path given.\nRun &apos;revel help run&apos; for usage.\n&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Determine the run mode.</span><br><span class="line">mode := &quot;dev&quot;</span><br><span class="line">if len(args) &gt;= 2 &#123;</span><br><span class="line">	mode = args[1]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判定参数数量，如果多于2个参数则用第一个参数dev或者prod作为运行模式，不然采用默认dev运行模式。</p>
<h2 id="Revel-Init"><a href="#Revel-Init" class="headerlink" title="Revel.Init"></a>Revel.Init</h2><p>接着调用revel.go下 <code>func Init(mode, importPath, srcPath string)</code>，调用代码：<code>revel.Init(mode, args[0], &quot;&quot;)</code></p>
<p>1.该方法先设置各种路径。</p>
<ol>
<li><code>Config, err = LoadConfig(&quot;app.conf&quot;)</code>提取配置文件，读取配置参数。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func LoadConfig(confName string) (*MergedConfig, error) &#123;</span><br><span class="line">	var err error</span><br><span class="line">	for _, confPath := range ConfPaths &#123;</span><br><span class="line">		conf, err := config.ReadDefault(path.Join(confPath, confName))</span><br><span class="line">		if err == nil &#123;</span><br><span class="line">			return &amp;MergedConfig&#123;conf, &quot;&quot;&#125;, nil</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if err == nil &#123;</span><br><span class="line">		err = errors.New(&quot;not found&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	return nil, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实config为另一个库 <code>&quot;github.com/robfig/config&quot;</code>。</p>
<p>3.<code>func getLogger(name string) *log.Logger</code>方法生成TRACE、INFO、WARN、ERROR四个Logger。</p>
<ol>
<li><code>func loadModules()</code>加载各种资源模块。</li>
</ol>
<h2 id="Revel-LoadMimeConfig"><a href="#Revel-LoadMimeConfig" class="headerlink" title="Revel.LoadMimeConfig"></a>Revel.LoadMimeConfig</h2><p>此方法位于revel/util.go文件内。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func LoadMimeConfig() &#123;</span><br><span class="line">	var err error</span><br><span class="line">	mimeConfig, err = LoadConfig(&quot;mime-types.conf&quot;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		ERROR.Fatalln(&quot;Failed to load mime type config:&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载Revel目录下conf/mime-types.conf文件。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Determine the override port, if any.</span><br><span class="line">port := revel.HttpPort</span><br><span class="line">if len(args) == 3 &#123;</span><br><span class="line">	var err error</span><br><span class="line">	if port, err = strconv.Atoi(args[2]); err != nil &#123;</span><br><span class="line">		errorf(&quot;Failed to parse port as integer: %s&quot;, args[2])</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">revel.INFO.Printf(&quot;Running %s (%s) in %s mode\n&quot;, revel.AppName, revel.ImportPath, mode)</span><br><span class="line">revel.TRACE.Println(&quot;Base path:&quot;, revel.BasePath)</span><br></pre></td></tr></table></figure>
<p>提取运行的端口，打印将要运行的Server信息。</p>
<hr>
<h2 id="Source-Watch"><a href="#Source-Watch" class="headerlink" title="Source-Watch"></a>Source-Watch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// If the app is run in &quot;watched&quot; mode, use the harness to run it.</span><br><span class="line">if revel.Config.BoolDefault(&quot;watch&quot;, true) &amp;&amp; revel.Config.BoolDefault(&quot;watch.code&quot;, true) &#123;</span><br><span class="line">	revel.TRACE.Println(&quot;Running in watched mode.&quot;)</span><br><span class="line">	revel.HttpPort = port</span><br><span class="line">	harness.NewHarness().Run() // Never returns.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果配置文件内运行的watch模式，则要对src下的资源文件进行监控，发现有变化则要重新自动编译并运行。</p>
<p>在/revel/cmd/harness/harness.go文件里<code>func NewHarness() *Harness</code>生成一个harness。</p>
<h5 id="Harness-Run"><a href="#Harness-Run" class="headerlink" title="Harness.Run"></a>Harness.Run</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var paths []string</span><br><span class="line">if revel.Config.BoolDefault(&quot;watch.gopath&quot;, false) &#123;</span><br><span class="line">	gopaths := filepath.SplitList(build.Default.GOPATH)</span><br><span class="line">	paths = append(paths, gopaths...)</span><br><span class="line">&#125;</span><br><span class="line">paths = append(paths, revel.CodePaths...)</span><br></pre></td></tr></table></figure>
<p>准备Watcher需要的path  src的Code路径和gopath路径。</p>
<p>用revel/watcher.go生成watcher，文件内watcher引用其它库<code>&quot;gopkg.in/fsnotify.v1&quot;</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">watcher = revel.NewWatcher()</span><br><span class="line">watcher.Listen(h, paths...)</span><br></pre></td></tr></table></figure>
<h6 id="1-通过监听文件变化触发rebuild"><a href="#1-通过监听文件变化触发rebuild" class="headerlink" title="1. 通过监听文件变化触发rebuild"></a>1. 通过监听文件变化触发rebuild</h6><p>Listen方法内目前内容比较深入，就先不分析具体功能，不过我们需要注意到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">	if w.eagerRebuildEnabled() &#123;</span><br><span class="line">		// Create goroutine to notify file changes in real time</span><br><span class="line">		go w.NotifyWhenUpdated(listener, watcher)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">// If watcher.mode is set to eager, the application is rebuilt immediately</span><br><span class="line">// when a source file is changed.</span><br><span class="line">// This feature is available only in dev mode.</span><br><span class="line">func (w *Watcher) eagerRebuildEnabled() bool &#123;</span><br><span class="line">	return Config.BoolDefault(&quot;mode.dev&quot;, true) &amp;&amp;</span><br><span class="line">		Config.BoolDefault(&quot;watch&quot;, true) &amp;&amp;</span><br><span class="line">		Config.StringDefault(&quot;watcher.mode&quot;, &quot;normal&quot;) == &quot;eager&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">在配置文件内：</span><br><span class="line">//#If you set watcher.mode = &quot;eager&quot;, the server starts to recompile</span><br><span class="line">//#your application every time your application&apos;s files change.</span><br><span class="line">watcher.mode = &quot;normal&quot;</span><br></pre></td></tr></table></figure></p>
<h6 id="2-通过-ReverseProxy-实现请求时观察是否变化再重新rebuild"><a href="#2-通过-ReverseProxy-实现请求时观察是否变化再重新rebuild" class="headerlink" title="2. 通过 ReverseProxy 实现请求时观察是否变化再重新rebuild"></a>2. 通过 ReverseProxy 实现请求时观察是否变化再重新rebuild</h6><p>在<code>func NewHarness() *Harness</code>方法内设置反向代理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">serverUrl, _ := url.ParseRequestURI(fmt.Sprintf(scheme+&quot;://%s:%d&quot;, addr, port))</span><br><span class="line"></span><br><span class="line">harness := &amp;Harness&#123;</span><br><span class="line">	port:       port,</span><br><span class="line">	serverHost: serverUrl.String()[len(scheme+&quot;://&quot;):],</span><br><span class="line">	proxy:      httputil.NewSingleHostReverseProxy(serverUrl),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">go func() &#123;</span><br><span class="line">		addr := fmt.Sprintf(&quot;%s:%d&quot;, revel.HttpAddr, revel.HttpPort)</span><br><span class="line">		revel.INFO.Printf(&quot;Listening on %s&quot;, addr)</span><br><span class="line"></span><br><span class="line">		var err error</span><br><span class="line">		if revel.HttpSsl &#123;</span><br><span class="line">			err = http.ListenAndServeTLS(addr, revel.HttpSslCert,</span><br><span class="line">				revel.HttpSslKey, h)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			err = http.ListenAndServe(addr, h)</span><br><span class="line">		&#125;</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			revel.ERROR.Fatalln(&quot;Failed to start reverse proxy:&quot;, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br></pre></td></tr></table></figure>
<p>用go的并发开启接收请求的代理服务器，将harness作为回调入口。因为harness实现了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A Handler responds to an HTTP request.</span><br><span class="line"></span><br><span class="line">type Handler interface &#123;</span><br><span class="line">        ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// ServeHTTP handles all requests.</span><br><span class="line">// It checks for changes to app, rebuilds if necessary, and forwards the request.</span><br><span class="line">func (hp *Harness) ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">	// Don&apos;t rebuild the app for favicon requests.</span><br><span class="line">	if lastRequestHadError &gt; 0 &amp;&amp; r.URL.Path == &quot;/favicon.ico&quot; &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Flush any change events and rebuild app if necessary.</span><br><span class="line">	// Render an error page if the rebuild / restart failed.</span><br><span class="line">	err := watcher.Notify()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		atomic.CompareAndSwapInt32(&amp;lastRequestHadError, 0, 1)</span><br><span class="line">		renderError(w, r, err)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	atomic.CompareAndSwapInt32(&amp;lastRequestHadError, 1, 0)</span><br><span class="line"></span><br><span class="line">	// Reverse proxy the request.</span><br><span class="line">	// (Need special code for websockets, courtesy of bradfitz)</span><br><span class="line">	if strings.EqualFold(r.Header.Get(&quot;Upgrade&quot;), &quot;websocket&quot;) &#123;</span><br><span class="line">		proxyWebsocket(w, r, hp.serverHost)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		hp.proxy.ServeHTTP(w, r)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>err := watcher.Notify()</code>此处会触发watcher的Notify方法，最后调用harness的Refresh方法进行重新build。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// Rebuild the Revel application and run it on the given port.</span><br><span class="line">func (h *Harness) Refresh() (err *revel.Error) &#123;</span><br><span class="line">	if h.app != nil &#123;</span><br><span class="line">		h.app.Kill()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	revel.TRACE.Println(&quot;Rebuild&quot;)</span><br><span class="line">	h.app, err = Build()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	h.app.Port = h.port</span><br><span class="line">	if err2 := h.app.Cmd().Start(); err2 != nil &#123;</span><br><span class="line">		return &amp;revel.Error&#123;</span><br><span class="line">			Title:       &quot;App failed to start up&quot;,</span><br><span class="line">			Description: err2.Error(),</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>h.app, err = Build()</code> 和 RunApp 方法内 <code>app, err := harness.Build()</code> 后，是进行build操作。</p>
<p>在harness.go文件的 <code>func (hp *Harness) ServeHTTP(w http.ResponseWriter, r *http.Request)</code>方法内处理完rebuild并重新开始服务器后，最后利用 ReverseProxy <code>hp.proxy.ServeHTTP(w, r)</code> 传入请求进行处理。</p>
<h1 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h1><p>开始执行/revel/cmd/revel/build.go文件内 <code>func Build(buildFlags ...string) (app *App, compileError *revel.Error)</code> 方法。</p>
<p><code>cleanSource(&quot;tmp&quot;, &quot;routes&quot;)</code>：在new的时候提到过，tmp、routes是编译时自动生成的，所以在rebuild里需要先清理一下。</p>
<p>接下来准备source info 和 dbImportPath：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sourceInfo, compileError := ProcessSource(revel.CodePaths)</span><br><span class="line">if compileError != nil &#123;</span><br><span class="line">	return nil, compileError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Add the db.import to the import paths.</span><br><span class="line">if dbImportPath, found := revel.Config.String(&quot;db.import&quot;); found &#123;</span><br><span class="line">	sourceInfo.InitImportPaths = append(sourceInfo.InitImportPaths, dbImportPath)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再接下来就是生成 main.go 和 routes.go ，这个在后面部分再深究：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Generate two source files.</span><br><span class="line">templateArgs := map[string]interface&#123;&#125;&#123;</span><br><span class="line">	&quot;Controllers&quot;:    sourceInfo.ControllerSpecs(),</span><br><span class="line">	&quot;ValidationKeys&quot;: sourceInfo.ValidationKeys,</span><br><span class="line">	&quot;ImportPaths&quot;:    calcImportAliases(sourceInfo),</span><br><span class="line">	&quot;TestSuites&quot;:     sourceInfo.TestSuites(),</span><br><span class="line">&#125;</span><br><span class="line">genSource(&quot;tmp&quot;, &quot;main.go&quot;, MAIN, templateArgs)</span><br><span class="line">genSource(&quot;routes&quot;, &quot;routes.go&quot;, ROUTES, templateArgs)</span><br></pre></td></tr></table></figure>
<p><code>buildTags := revel.Config.StringDefault(&quot;build.tags&quot;, &quot;&quot;)</code>, buildTags读入。</p>
<p><code>goPath, err := exec.LookPath(&quot;go&quot;)</code>,go执行路径。</p>
<p><code>pkg, err := build.Default.Import(revel.ImportPath, &quot;&quot;, build.FindOnly)</code>，应用资源目录。</p>
<p><code>binName := path.Join(pkg.BinDir, &quot;revel.d&quot;, revel.ImportPath, path.Base(revel.BasePath))</code>，这个需要注意一下，是生成的可执行包要导出的位置。</p>
<p>准备编译可执行文件需要的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">appVersion := getAppVersion()</span><br><span class="line">		versionLinkerFlags := fmt.Sprintf(&quot;-X %s/app.APP_VERSION \&quot;%s\&quot;&quot;, revel.ImportPath, appVersion)</span><br><span class="line">		flags := []string&#123;</span><br><span class="line">			&quot;build&quot;,</span><br><span class="line">			&quot;-ldflags&quot;, versionLinkerFlags,</span><br><span class="line">			&quot;-tags&quot;, buildTags,</span><br><span class="line">			&quot;-o&quot;, binName&#125;</span><br><span class="line"></span><br><span class="line">		// Add in build flags</span><br><span class="line">		flags = append(flags, buildFlags...)</span><br><span class="line"></span><br><span class="line">		// The main path</span><br><span class="line">		flags = append(flags, path.Join(revel.ImportPath, &quot;app&quot;, &quot;tmp&quot;))</span><br></pre></td></tr></table></figure>
<p>生成可执行文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buildCmd := exec.Command(goPath, flags...)</span><br><span class="line">revel.TRACE.Println(&quot;Exec:&quot;, buildCmd.Args)</span><br><span class="line">output, err := buildCmd.CombinedOutput()</span><br></pre></td></tr></table></figure>
<p>再关注到/revel/cmd/harness/app.go文件，用<code>func NewApp(binPath string) *App</code>生成应用返回到run.go的runApp方法内，调用app的 <code>func (a *App) Cmd() AppCmd</code> and <code>func (cmd AppCmd) Run()</code> 开始运行程序。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>在harness内还有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Kill the app on signal.</span><br><span class="line">	ch := make(chan os.Signal)</span><br><span class="line">	signal.Notify(ch, os.Interrupt, os.Kill)</span><br><span class="line">	&lt;-ch</span><br><span class="line">	if h.app != nil &#123;</span><br><span class="line">		h.app.Kill()</span><br><span class="line">	&#125;</span><br><span class="line">	os.Exit(1)</span><br></pre></td></tr></table></figure>
<p>用Channel 等待 signal 的os.Interrupt 或者 os.Kill 信号事件，如果h.app存在刚kill掉应用，最后退出revel应用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/28/Revel-run干了什么？/" data-id="cimd8jb76000jtkzld81bt6he" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端/">后端</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Bond-Observable" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/28/Bond-Observable/" class="article-date">
  <time datetime="2016-03-28T08:35:09.000Z" itemprop="datePublished">2016-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/28/Bond-Observable/">Bond-Observable</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Swift Bond是一个binding framework，与ReactiveCocoa、RxSwift都有相通之处。</p>
<p>github : <a href="https://github.com/SwiftBond/Bond" target="_blank" rel="external">https://github.com/SwiftBond/Bond</a></p>
<p>运用Swift Bond可以让UI管理更容易，同时它的核心概念部分是纯Swift写的，可以参考用于完成其它任务。<br>在raywenderlich有一文(<a href="https://www.raywenderlich.com/123108/bond-tutorial)讲解Swift" target="_blank" rel="external">https://www.raywenderlich.com/123108/bond-tutorial)讲解Swift</a> Bond的用法，同时运用Bond讲解如何实现MVVM。</p>
<p>这里说明Swift Bond最基础的Observable处理流程。</p>
<h1 id="EventProducerType"><a href="#EventProducerType" class="headerlink" title="EventProducerType"></a>EventProducerType</h1><p>这是框架最为核心的protocol：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public protocol EventProducerType &#123;</span><br><span class="line">  </span><br><span class="line">  /// Type of event objects or values that the observable generates.</span><br><span class="line">  typealias EventType</span><br><span class="line">  </span><br><span class="line">  /// Maximum number of past events that will be sent to each new observer upon registering.</span><br><span class="line">  /// Actual number of sent events may be less if not enough events were generated previously.</span><br><span class="line">  var replayLength: Int &#123; get &#125;</span><br><span class="line">  </span><br><span class="line">  /// Registers the given observer and returns a disposable that can cancel observing.</span><br><span class="line">  func observe(observer: EventType -&gt; Void) -&gt; DisposableType</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>replayLength</code>属性结合<code>public struct Buffer&lt;EventType&gt;</code>主要功能记录主题对象最近的事件值。</p>
<p><code>func observe(observer: EventType -&gt; Void)</code>增加新的观察对象。</p>
<p><code>public class EventProducer&lt;Event&gt;: EventProducerType</code> 是框架内直接实现的 EventProducerType 的类，<code>public final class Observable&lt;Wrapped&gt;: EventProducer&lt;Wrapped&gt;</code>是继承 EventProducer 而来，被定义为final，在应用内简单使用 Observable 类定义主题对象就行。</p>
<h1 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h1><p>Buffer定义了一个size大小FIFO的队列用于记录主题对象最近size次事件值。</p>
<p>push func管理队列值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public mutating func push(event: EventType) &#123;</span><br><span class="line">    if size == 1 &#123;</span><br><span class="line">      if buffer.count == 0 &#123;</span><br><span class="line">        buffer.append(event)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        buffer[0] = event;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      buffer.append(event)</span><br><span class="line">      if buffer.count &gt; size &#123;</span><br><span class="line">        buffer.removeFirst()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>replayTo func 重放输出事件值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public func replayTo(sink: EventType -&gt; Void) &#123;</span><br><span class="line">  for event in buffer &#123;</span><br><span class="line">    sink(event)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h1><p>观察主题对象类，直接初始化使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public init(_ value: Wrapped) &#123;</span><br><span class="line">  super.init(replayLength: 1)</span><br><span class="line">  next(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public func next(event: Event) &#123;</span><br><span class="line">  replayBuffer?.push(event)</span><br><span class="line">  dispatchNext(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.定义一个length为1的Buffer<br>2.分发初始值：push到Buffer，分发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public var value: Wrapped &#123;</span><br><span class="line">  get &#123;</span><br><span class="line">    // We&apos;ve created buffer of size 1 and we own it so it is safe</span><br><span class="line">    // to force unwrap both the buffer and the last element.</span><br><span class="line">    return replayBuffer!.last!</span><br><span class="line">  &#125;</span><br><span class="line">  set &#123;</span><br><span class="line">    next(newValue)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义一个value变量用于存储当前事件值，运用Swift的属性观察机制触发事件分发。</p>
<h1 id="运行调用observe"><a href="#运行调用observe" class="headerlink" title="运行调用observe"></a>运行调用observe</h1><p>要注册观察者需要调用 EventProducerType 的 <code>func observe(observer: EventType -&gt; Void) -&gt; DisposableType</code>，此方法在 EventProducer 内实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public func observe(observer: Event -&gt; Void) -&gt; DisposableType &#123;</span><br><span class="line">  </span><br><span class="line">  if lifecycle == .Managed &#123;</span><br><span class="line">    selfReference?.retain()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  let eventProducerBaseDisposable = addObserver(observer)</span><br><span class="line">  </span><br><span class="line">  replayBuffer?.replayTo(observer)</span><br><span class="line">  </span><br><span class="line">  let observerDisposable = BlockDisposable &#123; [weak self] in</span><br><span class="line">    eventProducerBaseDisposable.dispose()</span><br><span class="line">    </span><br><span class="line">    if let unwrappedSelf = self &#123;</span><br><span class="line">      if unwrappedSelf.observers.count == 0 &#123;</span><br><span class="line">        unwrappedSelf.selfReference?.release()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  deinitDisposable += observerDisposable</span><br><span class="line">  return observerDisposable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此方法内大部分代码都是管理引用，<code>let eventProducerBaseDisposable = addObserver(observer)</code> 增加观察都对象 和 <code>replayBuffer?.replayTo(observer)</code> 将Buffer里的事件值向新增加的观察都观象重放输入。</p>
<p>在 EventProducer 内实现标准的观察者主题的方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private func dispatchNext(event: Event) &#123;</span><br><span class="line">  guard !isDispatchInProgress else &#123; return &#125;</span><br><span class="line">  </span><br><span class="line">  lock.lock()</span><br><span class="line">  isDispatchInProgress = true</span><br><span class="line">  for (_, send) in observers &#123;</span><br><span class="line">    send(event)</span><br><span class="line">  &#125;</span><br><span class="line">  isDispatchInProgress = false</span><br><span class="line">  lock.unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private func addObserver(observer: Event -&gt; Void) -&gt; DisposableType &#123;</span><br><span class="line">  lock.lock()</span><br><span class="line">  let token = nextToken</span><br><span class="line">  nextToken = nextToken + 1</span><br><span class="line">  lock.unlock()</span><br><span class="line">  </span><br><span class="line">  observers[token] = observer</span><br><span class="line">  return EventProducerDisposable(eventProducer: self, token: token)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private func removeObserver(disposable: EventProducerDisposable&lt;Event&gt;) &#123;</span><br><span class="line">  observers.removeValueForKey(disposable.token)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="运行代码"><a href="#运行代码" class="headerlink" title="运行代码"></a>运行代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class BindViewModel &#123;</span><br><span class="line">    let object = Observable&lt;String&gt;(&quot;init&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class BindViewController : UIViewController &#123;</span><br><span class="line">    </span><br><span class="line">    let viewModel = BindViewModel()</span><br><span class="line">    </span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        viewModel.object.observe &#123; (eventValue) -&gt; Void in</span><br><span class="line">            print(eventValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func action() &#123;</span><br><span class="line">        viewModel.object.value = &quot;1&quot;</span><br><span class="line">        viewModel.object.value = &quot;2&quot;</span><br><span class="line">        viewModel.object.value = &quot;3&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">运行输出：</span><br><span class="line">init</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>
<h4 id="observeNew"><a href="#observeNew" class="headerlink" title="observeNew"></a>observeNew</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public func observeNew(observer: EventType -&gt; Void) -&gt; DisposableType &#123;</span><br><span class="line">  var skip: Int = replayLength</span><br><span class="line">  return observe &#123; value in</span><br><span class="line">    if skip &gt; 0 &#123;</span><br><span class="line">      skip--</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      observer(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此方法为 EventProducerType extension方法，对observe封装一层，让新注册的观察者对象skip replayLength次事件值的分发，可以理解为跳过主题对象Buffer存储的旧事件，只有在注册后的新值才会被分发，，，结合名称就很好理解了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class BindViewModel &#123;</span><br><span class="line">    let object = Observable&lt;String&gt;(&quot;init&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class BindViewController : UIViewController &#123;</span><br><span class="line">    </span><br><span class="line">    let viewModel = BindViewModel()</span><br><span class="line">    </span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        viewModel.object.observeNew &#123; (eventValue) -&gt; Void in</span><br><span class="line">            print(eventValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func action() &#123;</span><br><span class="line">        viewModel.object.value = &quot;1&quot;</span><br><span class="line">        viewModel.object.value = &quot;2&quot;</span><br><span class="line">        viewModel.object.value = &quot;3&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">运行输出：</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/28/Bond-Observable/" data-id="cimd8jb79000mtkzli3tgckbz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Revel-新建一个应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/27/Revel-新建一个应用/" class="article-date">
  <time datetime="2016-03-27T13:14:47.000Z" itemprop="datePublished">2016-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/27/Revel-新建一个应用/">Revel-new准备了什么？</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>运用Go内建命令获得Revel framework，参考地址: <a href="https://revel.github.io/tutorial/gettingstarted.html" target="_blank" rel="external">https://revel.github.io/tutorial/gettingstarted.html</a></p>
<p>其中Revel命令行相关的文件单独放在了./src/cmd/revel目录下，简单需要用的两个命令参数：</p>
<ol>
<li>revel new ： 新建一个应用</li>
<li>revel run ： 运行一个应用</li>
</ol>
<h3 id="Revel应用"><a href="#Revel应用" class="headerlink" title="Revel应用"></a>Revel应用</h3><p>main package 在/revel/cmd/revel/rev.go文件内。</p>
<figure class="highlight plain"><figcaption><span>Cribbed from the genius organization of the "go" command.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">type Command struct &#123;</span><br><span class="line">	Run                    func(args []string)</span><br><span class="line">	UsageLine, Short, Long string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (cmd *Command) Name() string &#123;</span><br><span class="line">	name := cmd.UsageLine</span><br><span class="line">	i := strings.Index(name, &quot; &quot;)</span><br><span class="line">	if i &gt;= 0 &#123;</span><br><span class="line">		name = name[:i]</span><br><span class="line">	&#125;</span><br><span class="line">	return name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var commands = []*Command&#123;</span><br><span class="line">	cmdNew,</span><br><span class="line">	cmdRun,</span><br><span class="line">	cmdBuild,</span><br><span class="line">	cmdPackage,</span><br><span class="line">	cmdClean,</span><br><span class="line">	cmdTest,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	flag.Usage = func() &#123; usage(1) &#125;</span><br><span class="line">	flag.Parse()</span><br><span class="line">	args := flag.Args()</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	for _, cmd := range commands &#123;</span><br><span class="line">		if cmd.Name() == args[0] &#123;</span><br><span class="line">			cmd.Run(args[1:])</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行指定命令 …</p>
<h2 id="New"><a href="#New" class="headerlink" title="New"></a>New</h2><p>今天的任务记录下 new 执行操作，主要内容为./src/cmd/revel/new.go 文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var cmdNew = &amp;Command&#123;</span><br><span class="line">	UsageLine: &quot;new [path] [skeleton]&quot;,</span><br><span class="line">	Short:     &quot;create a skeleton Revel application&quot;,</span><br><span class="line">	Long: `</span><br><span class="line">New creates a few files to get a new Revel application running quickly.</span><br><span class="line"></span><br><span class="line">It puts all of the files in the given import path, taking the final element in</span><br><span class="line">the path to be the app name.</span><br><span class="line"></span><br><span class="line">Skeleton is an optional argument, provided as an import path</span><br><span class="line"></span><br><span class="line">For example:</span><br><span class="line"></span><br><span class="line">    revel new import/path/helloworld</span><br><span class="line"></span><br><span class="line">    revel new import/path/helloworld import/path/skeleton</span><br><span class="line">`,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">	cmdNew.Run = newApp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newApp(args []string)</span><br></pre></td></tr></table></figure>
<p>这里介绍了new 命令调用方式，revel 命令会对整个参数作处理，并将new后的参数作为newApp的参数运行newApp func。</p>
<h2 id="initGoPaths-func"><a href="#initGoPaths-func" class="headerlink" title="initGoPaths func"></a>initGoPaths func</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func initGoPaths() &#123;</span><br><span class="line">	// lookup go path</span><br><span class="line">	gopath = build.Default.GOPATH</span><br><span class="line">	if gopath == &quot;&quot; &#123;</span><br><span class="line">		errorf(&quot;Abort: GOPATH environment variable is not set. &quot; +</span><br><span class="line">			&quot;Please refer to http://golang.org/doc/code.html to configure your Go environment.&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// set go src path</span><br><span class="line">	srcRoot = filepath.Join(filepath.SplitList(gopath)[0], &quot;src&quot;)</span><br><span class="line"></span><br><span class="line">	// check for go executable</span><br><span class="line">	var err error</span><br><span class="line">	gocmd, err = exec.LookPath(&quot;go&quot;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		errorf(&quot;Go executable not found in PATH.&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在go/build下定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var Default Context = defaultContext()</span><br><span class="line"></span><br><span class="line">Default is the default Context for builds. It uses the GOARCH, GOOS, GOROOT, and GOPATH environment variables if set, or else the compiled code&apos;s GOARCH, GOOS, and GOROOT.</span><br></pre></td></tr></table></figure>
<p>所以 <code>gopath = build.Default.GOPATH</code> 是判定系统是否设置了GOPATH</p>
<p><code>srcRoot = filepath.Join(filepath.SplitList(gopath)[0], &quot;src&quot;)</code>将第0个GOPATH追加/src作为新应用的source目录。</p>
<p>文档定义exec.LookPath:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func LookPath(file string) (string, error)</span><br><span class="line"></span><br><span class="line">LookPath searches for an executable binary named file in the directories named by the PATH environment variable. If file contains a slash, it is tried directly and the PATH is not consulted. The result may be an absolute path or a path relative to the current directory.</span><br></pre></td></tr></table></figure>
<p><code>gocmd, err = exec.LookPath(&quot;go&quot;)</code> 找到go命令的执行路径。</p>
<h2 id="setApplicationPath-func"><a href="#setApplicationPath-func" class="headerlink" title="setApplicationPath func"></a>setApplicationPath func</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">func setApplicationPath(args []string) &#123;</span><br><span class="line">	var err error</span><br><span class="line">	importPath = args[0]</span><br><span class="line">	if filepath.IsAbs(importPath) &#123;</span><br><span class="line">		errorf(&quot;Abort: &apos;%s&apos; looks like a directory.  Please provide a Go import path instead.&quot;,</span><br><span class="line">			importPath)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = build.Import(importPath, &quot;&quot;, build.FindOnly)</span><br><span class="line">	if err == nil &#123;</span><br><span class="line">		errorf(&quot;Abort: Import path %s already exists.\n&quot;, importPath)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	revelPkg, err = build.Import(revel.REVEL_IMPORT_PATH, &quot;&quot;, build.FindOnly)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		errorf(&quot;Abort: Could not find Revel source code: %s\n&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	appPath = filepath.Join(srcRoot, filepath.FromSlash(importPath))</span><br><span class="line">	appName = filepath.Base(appPath)</span><br><span class="line">	basePath = filepath.ToSlash(filepath.Dir(importPath))</span><br><span class="line"></span><br><span class="line">	if basePath == &quot;.&quot; &#123;</span><br><span class="line">		// we need to remove the a single &apos;.&apos; when</span><br><span class="line">		// the app is in the $GOROOT/src directory</span><br><span class="line">		basePath = &quot;&quot;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		// we need to append a &apos;/&apos; when the app is</span><br><span class="line">		// is a subdirectory such as $GOROOT/src/path/to/revelapp</span><br><span class="line">		basePath += &quot;/&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>importPath = args[0]</code>可用于被其它应用导入引用的目录。</p>
<p>build.Import定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func (ctxt *Context) Import(path string, srcDir string, mode ImportMode) (*Package, error)</span><br><span class="line"></span><br><span class="line">If an error occurs, Import returns a non-nil error and a non-nil *Package containing partial information.</span><br></pre></td></tr></table></figure>
<p><code>_, err = build.Import(importPath, &quot;&quot;, build.FindOnly)</code>判定准备新建的应用路径是否已经存在。</p>
<p>在revel.go文件下定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const (</span><br><span class="line">	REVEL_IMPORT_PATH = &quot;github.com/revel/revel&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>revelPkg, err = build.Import(revel.REVEL_IMPORT_PATH, &quot;&quot;, build.FindOnly)</code> 判定是否已经获取的revel framework 资源。</p>
<p><code>appPath = filepath.Join(srcRoot, filepath.FromSlash(importPath))</code> 生成完整的appPath。</p>
<p><code>appName = filepath.Base(appPath)</code> 获取应用的名称。</p>
<p><code>basePath = filepath.ToSlash(filepath.Dir(importPath))</code>应用的相对src 目录。</p>
<h2 id="setSkeletonPath"><a href="#setSkeletonPath" class="headerlink" title="setSkeletonPath"></a>setSkeletonPath</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func setSkeletonPath(args []string) &#123;</span><br><span class="line">	var err error</span><br><span class="line">	if len(args) == 2 &#123; // user specified</span><br><span class="line">		skeletonName := args[1]</span><br><span class="line">		_, err = build.Import(skeletonName, &quot;&quot;, build.FindOnly)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			// Execute &quot;go get &lt;pkg&gt;&quot;</span><br><span class="line">			getCmd := exec.Command(gocmd, &quot;get&quot;, &quot;-d&quot;, skeletonName)</span><br><span class="line">			fmt.Println(&quot;Exec:&quot;, getCmd.Args)</span><br><span class="line">			getOutput, err := getCmd.CombinedOutput()</span><br><span class="line"></span><br><span class="line">			// check getOutput for no buildible string</span><br><span class="line">			bpos := bytes.Index(getOutput, []byte(&quot;no buildable Go source files in&quot;))</span><br><span class="line">			if err != nil &amp;&amp; bpos == -1 &#123;</span><br><span class="line">				errorf(&quot;Abort: Could not find or &apos;go get&apos; Skeleton  source code: %s\n%s\n&quot;, getOutput, skeletonName)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		// use the</span><br><span class="line">		skeletonPath = filepath.Join(srcRoot, skeletonName)</span><br><span class="line"></span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		// use the revel default</span><br><span class="line">		skeletonPath = filepath.Join(revelPkg.Dir, &quot;skeleton&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>newApp第二个参数是用于导入skelenton的，如果没有第二个参数则用revel框架默认自带的资源在/src/github.com/revel/revel/skeleton下。</p>
<p>先用<code>_, err = build.Import(skeletonName, &quot;&quot;, build.FindOnly)</code>直接导入本地资源，如果不存在这里就要用到之前准备好的gocomd路径调用系统go命令以get的方式从网上拉取资源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">getCmd := exec.Command(gocmd, &quot;get&quot;, &quot;-d&quot;, skeletonName)</span><br><span class="line">fmt.Println(&quot;Exec:&quot;, getCmd.Args)</span><br><span class="line">getOutput, err := getCmd.CombinedOutput()</span><br><span class="line"></span><br><span class="line">// check getOutput for no buildible string</span><br><span class="line">bpos := bytes.Index(getOutput, []byte(&quot;no buildable Go source files in&quot;))</span><br><span class="line">if err != nil &amp;&amp; bpos == -1 &#123;</span><br><span class="line">	errorf(&quot;Abort: Could not find or &apos;go get&apos; Skeleton  source code: %s\n%s\n&quot;, getOutput, skeletonName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后得到 skeletonPath :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">skeletonPath = filepath.Join(srcRoot, skeletonName) //有参数</span><br><span class="line">skeletonPath = filepath.Join(revelPkg.Dir, &quot;skeleton&quot;) //无参数，默认</span><br></pre></td></tr></table></figure>
<h2 id="copyNewAppFiles"><a href="#copyNewAppFiles" class="headerlink" title="copyNewAppFiles"></a>copyNewAppFiles</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func copyNewAppFiles() &#123;</span><br><span class="line">	var err error</span><br><span class="line">	err = os.MkdirAll(appPath, 0777)</span><br><span class="line">	panicOnError(err, &quot;Failed to create directory &quot;+appPath)</span><br><span class="line"></span><br><span class="line">	mustCopyDir(appPath, skeletonPath, map[string]interface&#123;&#125;&#123;</span><br><span class="line">		// app.conf</span><br><span class="line">		&quot;AppName&quot;:  appName,</span><br><span class="line">		&quot;BasePath&quot;: basePath,</span><br><span class="line">		&quot;Secret&quot;:   generateSecret(),</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	// Dotfiles are skipped by mustCopyDir, so we have to explicitly copy the .gitignore.</span><br><span class="line">	gitignore := &quot;.gitignore&quot;</span><br><span class="line">	mustCopyFile(filepath.Join(appPath, gitignore), filepath.Join(skeletonPath, gitignore))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法主要是建一个appPath的目录，设置权限为0777。<br>调用mustCopyDir方法复制文件，该定义在/cmd/revel/util.go文件里。</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>根据模板生成主要包括app、conf、messages、public、tests文件夹和README.ME文件。</p>
<p>最开始我是很纠结的，就是木有找到main方法的入口，非常让我郁闷，都开始怀疑不需要main包也能运行（当然这是说笑，只是研究到点上而已）。</p>
<p>不过最终我找到该文件，是在调用run或者build时在Build阶段由framework在app目录下自动生成子目录。</p>
<p>1.会生成一个tmp文件夹 里面有main.go。<br>2.还会生成一个routes文件 里面有routes.go。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/27/Revel-新建一个应用/" data-id="cimd8jb6o0008tkzlvr0anua1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端/">后端</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-后端小记开始" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/27/后端小记开始/" class="article-date">
  <time datetime="2016-03-27T13:04:07.000Z" itemprop="datePublished">2016-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/27/后端小记开始/">后端小记开始</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>记的东西越多，忘得越快，为了忘时能快速回忆，所以还是得记下来 – 致开始衰退的记忆力</p>
<hr>
<p>从开始转行干编程的活，主要是以iOS开发为主，前两年Object-C，目前已用Swift快一年进入感觉和领悟也开始记下，OC的还会写，但是已经没有那么熟悉能记下的都是比较重要的部分了。</p>
<p>其它语言到现在各种都有看过；不过最让我怀念的还是大学的时候，记得汇编学得挺不错的，可惜现在是一点反应都没有。其它像C、Java都是写写语法，没有实战。唯一实战的就只有js、HTML了，毕竟在iOS开发上也要用到。</p>
<p>一不小心就开始接触Go语言，也拿着练了练手写着感觉还不错，当然Swift现在也能进行后端开发，但俗话说，不能在一棵树上吊死嘛，长点见识总是好的，所以毅然还是Go吧。</p>
<p>使用Go语言、Revel框架、MySQL作为记录的开始。</p>
<hr>
<p>各种准备就不说了，参考</p>
<p>Go语言官方网站：<a href="http://golang.org/" target="_blank" rel="external">http://golang.org/</a></p>
<p>Revel官方文档：<a href="http://revel.github.io/index.html" target="_blank" rel="external">http://revel.github.io/index.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/27/后端小记开始/" data-id="cimd8jb70000ftkzlnrb57l62" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端/">后端</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-观察者模式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/26/观察者模式/" class="article-date">
  <time datetime="2016-03-26T11:05:26.000Z" itemprop="datePublished">2016-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/26/观察者模式/">观察者模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>//设计原则一：为了交互对象之间的松耦合设计而努力。<br>//松耦合的设计之所以能让我们建立有弹性的oo系统，能够应对变化，是因为对象之间的互相依赖降到了最低。</p>
<p>//观察者模式：定义了对象之间的一对多依赖，这样一来，当一个对象改变状态时，它的所有依赖者都会收到通知并自动更新。</p>
<hr>
<h2 id="接口声明"><a href="#接口声明" class="headerlink" title="接口声明"></a>接口声明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protocol Observer &#123;</span><br><span class="line">    var id : Int &#123;get set&#125;</span><br><span class="line">    func update(temp : Float, humidity : Float, pressure : Float)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protocol Subject &#123;</span><br><span class="line">    func registerObserver(o : Observer)</span><br><span class="line">    func removeObserver(o : Observer)</span><br><span class="line">    func notifyObservers()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="主题对象实现接口"><a href="#主题对象实现接口" class="headerlink" title="主题对象实现接口"></a>主题对象实现接口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">class WeatherData: Subject &#123;</span><br><span class="line">    private var observers = Array&lt;Observer&gt;()</span><br><span class="line">    </span><br><span class="line">    private var temp : Float = 0.0 &#123;</span><br><span class="line">        didSet &#123;</span><br><span class="line">            notifyObservers()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private var humidity : Float = 0.0 &#123;</span><br><span class="line">        didSet &#123;</span><br><span class="line">            notifyObservers()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private var pressure : Float = 0.0 &#123;</span><br><span class="line">        didSet &#123;</span><br><span class="line">            notifyObservers()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func registerObserver(o: Observer) &#123;</span><br><span class="line">        observers.append(o)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func removeObserver(o: Observer) &#123;</span><br><span class="line">        let index = observers.indexOf &#123; (ob) -&gt; Bool in</span><br><span class="line">            return o.id == ob.id</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        guard index != nil else &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        observers.removeAtIndex(index!)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    internal func notifyObservers() &#123;</span><br><span class="line">        for o in observers &#123;</span><br><span class="line">            o.update(temp, humidity: humidity, pressure: pressure)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="观察者实现接口"><a href="#观察者实现接口" class="headerlink" title="观察者实现接口"></a>观察者实现接口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">protocol DisplayElement &#123;</span><br><span class="line">    func display()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var index : Int = 0</span><br><span class="line"></span><br><span class="line">class CurrentConditionsDisplay: Observer, DisplayElement &#123;</span><br><span class="line">    internal var id : Int</span><br><span class="line">    private var temp : Float = 0.0</span><br><span class="line">    private var humidity : Float = 0.0</span><br><span class="line">    private var pressure : Float = 0.0</span><br><span class="line">    </span><br><span class="line">    init() &#123;</span><br><span class="line">        id = ++index</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func update(temp: Float, humidity: Float, pressure: Float) &#123;</span><br><span class="line">        self.temp = temp</span><br><span class="line">        self.humidity = humidity</span><br><span class="line">        self.pressure = pressure</span><br><span class="line">        </span><br><span class="line">        display()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func display() &#123;</span><br><span class="line">       print(&quot;temp : \(temp), humidity : \(humidity), pressure : \(pressure)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let dataCenter = WeatherData()</span><br><span class="line">let displayPlat = CurrentConditionsDisplay()</span><br><span class="line">dataCenter.registerObserver(displayPlat)</span><br><span class="line"></span><br><span class="line">dataCenter.temp = 10</span><br><span class="line">dataCenter.pressure = 20</span><br><span class="line"></span><br><span class="line">dataCenter.removeObserver(displayPlat)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/26/观察者模式/" data-id="cimd8jb6w000dtkzlt6ljzgfg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DesignPattern/">DesignPattern</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Mirror" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/26/Mirror/" class="article-date">
  <time datetime="2016-03-26T07:57:22.000Z" itemprop="datePublished">2016-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/26/Mirror/">Mirror</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在OC中有很强大的runtime机制，能够运用语言的运行时特性发挥强大的能力。Swift作为静态语言，目前没有提供强大的运行时特性，官方标准库提供Mirror struct 用作反射能够进行查询。</p>
<p><a href="https://appventure.me/2015/10/24/swift-reflection-api-what-you-can-do/#fn.2" target="_blank" rel="external">参考链接</a>，该文里还有一个关于CoreData数据结构转化的 Custom例子</p>
<hr>
<h3 id="Mirror-官方描述："><a href="#Mirror-官方描述：" class="headerlink" title="Mirror 官方描述："></a>Mirror 官方描述：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/// Representation of the sub-structure and optional &quot;display style&quot;</span><br><span class="line">/// of any arbitrary subject instance.</span><br><span class="line">///</span><br><span class="line">/// Describes the parts---such as stored properties, collection</span><br><span class="line">/// elements, tuple elements, or the active enumeration case---that</span><br><span class="line">/// make up a particular instance.  May also supply a &quot;display style&quot;</span><br><span class="line">/// property that suggests how this structure might be rendered.</span><br><span class="line">///</span><br><span class="line">/// Mirrors are used by playgrounds and the debugger.</span><br></pre></td></tr></table></figure>
<h5 id="构造一个测试数据结构对Mirror属性进行说明："><a href="#构造一个测试数据结构对Mirror属性进行说明：" class="headerlink" title="构造一个测试数据结构对Mirror属性进行说明："></a>构造一个测试数据结构对Mirror属性进行说明：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct MI &#123;</span><br><span class="line">    let value : String</span><br><span class="line">    </span><br><span class="line">    func test() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let mi = MI(value: &quot;instanceValue&quot;)</span><br></pre></td></tr></table></figure>
<h5 id="初始化一个Mirror实例："><a href="#初始化一个Mirror实例：" class="headerlink" title="初始化一个Mirror实例："></a>初始化一个Mirror实例：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/// Reflect upon the given `subject`.</span><br><span class="line">///</span><br><span class="line">/// If the dynamic type of `subject` conforms to `CustomReflectable`,</span><br><span class="line">/// the resulting mirror is determined by its `customMirror` method.</span><br><span class="line">/// Otherwise, the result is generated by the language.</span><br><span class="line"></span><br><span class="line">public init(reflecting subject: Any)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let mmi = Mirror(reflecting: mi)  //Mirror for MI</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="SubjectType"><a href="#SubjectType" class="headerlink" title="SubjectType"></a>SubjectType</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/// The static type of the subject being reflected.</span><br><span class="line">///</span><br><span class="line">/// This type may differ from the subject&apos;s dynamic type when `self`</span><br><span class="line">/// is the `superclassMirror()` of another mirror.</span><br><span class="line"></span><br><span class="line">public let subjectType: Any.Type</span><br></pre></td></tr></table></figure>
<p>对象的类型（.Type）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mmi.subjectType   //MI.Type</span><br><span class="line"></span><br><span class="line">print(mmi.subjectType)    //&quot;MI\n&quot;</span><br></pre></td></tr></table></figure>
<h3 id="children"><a href="#children" class="headerlink" title="children"></a>children</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public typealias Child = (label: String?, value: Any)</span><br><span class="line"></span><br><span class="line">public typealias Children = AnyForwardCollection&lt;Child&gt;</span><br><span class="line"></span><br><span class="line">/// A collection of `Child` elements describing the structure of the</span><br><span class="line">/// reflected subject.</span><br><span class="line"></span><br><span class="line">public let children: Children</span><br></pre></td></tr></table></figure>
<p>对象结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mmi.children.count  // 1</span><br><span class="line"></span><br><span class="line">for (l, v) in mmi.children &#123;</span><br><span class="line">    print(l)          //   &quot;Optional(&quot;value&quot;)\n&quot;</span><br><span class="line">    print(v)		  //    &quot;instanceValue\n&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="displayStyle"><a href="#displayStyle" class="headerlink" title="displayStyle"></a>displayStyle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/// A suggestion of how a `Mirror`&apos;s is to be interpreted.</span><br><span class="line">   ///</span><br><span class="line">   /// Playgrounds and the debugger will show a representation similar</span><br><span class="line">   /// to the one used for instances of the kind indicated by the</span><br><span class="line">   /// `DisplayStyle` case name when the `Mirror` is used for display.</span><br><span class="line">   </span><br><span class="line">   public enum DisplayStyle &#123;</span><br><span class="line">       case Struct</span><br><span class="line">       case Class</span><br><span class="line">       case Enum</span><br><span class="line">       case Tuple</span><br><span class="line">       case Optional</span><br><span class="line">       case Collection</span><br><span class="line">       case Dictionary</span><br><span class="line">       case Set</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   /// Suggests a display style for the reflected subject.</span><br><span class="line">   </span><br><span class="line">   public let displayStyle: Mirror.DisplayStyle?</span><br></pre></td></tr></table></figure>
<p>对象反射 display style ,对于不支持的 Type ，返回 nil</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmi.displayStyle     // Struct</span><br></pre></td></tr></table></figure>
<h3 id="superclassMirror-gt-Mirror"><a href="#superclassMirror-gt-Mirror" class="headerlink" title="superclassMirror() -&gt; Mirror?"></a>superclassMirror() -&gt; Mirror?</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/// Representation of ancestor classes.</span><br><span class="line">    ///</span><br><span class="line">    /// A `CustomReflectable` class can control how its mirror will</span><br><span class="line">    /// represent ancestor classes by initializing the mirror with a</span><br><span class="line">    /// `AncestorRepresentation`.  This setting has no effect on mirrors</span><br><span class="line">    /// reflecting value type instances.</span><br><span class="line">    </span><br><span class="line">    public enum AncestorRepresentation &#123;</span><br><span class="line">        /// Generate a default mirror for all ancestor classes.  This is the</span><br><span class="line">        /// default behavior.</span><br><span class="line">        ///</span><br><span class="line">        /// - Note: This option bypasses any implementation of `customMirror`</span><br><span class="line">        ///   that may be supplied by a `CustomReflectable` ancestor, so this</span><br><span class="line">        ///   is typically not the right option for a `customMirror`implementation </span><br><span class="line">        /// Generate a default mirror for all ancestor classes.</span><br><span class="line">        ///</span><br><span class="line">        /// This case is the default.</span><br><span class="line">        ///</span><br><span class="line">        /// - Note: This option generates default mirrors even for</span><br><span class="line">        ///   ancestor classes that may implement `CustomReflectable`&apos;s</span><br><span class="line">        ///   `customMirror` requirement.  To avoid dropping an ancestor class</span><br><span class="line">        /// customization, an override of `customMirror()` should pass</span><br><span class="line">        /// `ancestorRepresentation: .Customized(super.customMirror)` when</span><br><span class="line">        /// initializing its `Mirror`.</span><br><span class="line">        case Generated</span><br><span class="line">        /// Use the nearest ancestor&apos;s implementation of `customMirror()` to</span><br><span class="line">        /// create a mirror for that ancestor.  Other classes derived from</span><br><span class="line">        /// such an ancestor are given a default mirror.</span><br><span class="line">        ///</span><br><span class="line">        /// The payload for this option should always be</span><br><span class="line">        /// &quot;`super.customMirror`&quot;:</span><br><span class="line">        ///</span><br><span class="line">        ///     func customMirror() -&gt; Mirror &#123;</span><br><span class="line">        ///       return Mirror(</span><br><span class="line">        ///         self,</span><br><span class="line">        ///         children: [&quot;someProperty&quot;: self.someProperty],</span><br><span class="line">        ///         ancestorRepresentation: .Customized(super.customMirror)) // &lt;==</span><br><span class="line">        ///     &#125;</span><br><span class="line">        case Customized(() -&gt; Mirror)</span><br><span class="line">        /// Suppress the representation of all ancestor classes.  The</span><br><span class="line">        /// resulting `Mirror`&apos;s `superclassMirror()` is `nil`.</span><br><span class="line">        case Suppressed</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>针对class类型返回 super的Mirror</p>
<p>Generated 是默认值</p>
<p>Customized(() -&gt; Mirror) 用最近的实现了 customMirror() 返回 mirror 作为 派生类 的默认mirror.</p>
<p>Suppressed 忽略 <code>superclassMirror()</code> is <code>nil</code></p>
<hr>
<h2 id="Custom-Mirror"><a href="#Custom-Mirror" class="headerlink" title="Custom Mirror"></a>Custom Mirror</h2><p>实现以下方法即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">extension Mirror : CustomReflectable &#123;</span><br><span class="line">    @warn_unused_result</span><br><span class="line">    public func customMirror() -&gt; Mirror</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Custom Code :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">extension MI : CustomReflectable &#123;</span><br><span class="line">    func customMirror() -&gt; Mirror &#123;</span><br><span class="line">        let children = DictionaryLiteral&lt;String, Any&gt;(dictionaryLiteral: **(&quot;customValue&quot;, &quot;custom:\(self.value)&quot;)**)</span><br><span class="line">        </span><br><span class="line">        return Mirror.init(MI.self, children: children, displayStyle: .Struct, ancestorRepresentation: .Suppressed)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>children 变化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mmi.children.count</span><br><span class="line"></span><br><span class="line">for (l, v) in mmi.children &#123;</span><br><span class="line">    print(l)			// **&quot;Optional(&quot;customValue&quot;)\n&quot;**</span><br><span class="line">    print(v)			// **&quot;custom:instanceValue\n&quot;**</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/26/Mirror/" data-id="cimd8jb6k0006tkzlo2u9naj4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Swift-元类型简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/25/Swift-元类型简介/" class="article-date">
  <time datetime="2016-03-25T12:24:18.000Z" itemprop="datePublished">2016-03-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/25/Swift-元类型简介/">Swift 元类型简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文主要是对Swift元类型知识小记。</p>
<p>先来一段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let v : String.Type = String.self</span><br><span class="line">(v).init(1) //&quot;1&quot;</span><br><span class="line"></span><br><span class="line">let vv : Any = String.self</span><br><span class="line">(vv as! String.Type).init(&quot;23&quot;)  // &quot;2&quot;</span><br></pre></td></tr></table></figure>
<p>上面一段代码关注的点： .Type 和 .self 操作。<br>.Type 用于类型名称后面 用于声明场景，表示某个类型的元类型。<br>.self 用于类型名称后面 表示取出该类型。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typealias AnyClass = AnyObject.Type</span><br></pre></td></tr></table></figure>
<p>AnyObject是为了和Object-C相通提出的解决方案。<br>AnyObject的元类型是声明为 AnyClass。<br>在Swift里面用Any表示任何。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let vv : Any = String.self</span><br><span class="line">(vv as! String.Type).init(&quot;23&quot;)  // &quot;2&quot;</span><br><span class="line"></span><br><span class="line">let vvv : Any.Type = String.self</span><br><span class="line">(vvv as! String.Type).init(&quot;2344&quot;)   // &quot;2344&quot;</span><br><span class="line"></span><br><span class="line">vv is Any.Type  // true</span><br><span class="line">vvv is Any      // &quot;is&quot; test is always true</span><br></pre></td></tr></table></figure>
<p>这个地方就有点荤菜了<br>Any可以表示任何东西。<br>Any.Type还是只能用作.Type 作用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/25/Swift-元类型简介/" data-id="cimd8jb6h0004tkzln4ysd4e3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Jenkins环境搭建与iOS自动构建包-0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/18/Jenkins环境搭建与iOS自动构建包-0/" class="article-date">
  <time datetime="2015-08-18T08:32:00.000Z" itemprop="datePublished">2015-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/18/Jenkins环境搭建与iOS自动构建包-0/">Jenkins环境搭建与iOS自动构建包</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文介绍采用Tomcat的方式运行Jenkins。</p>
<p>###安装Tomcat<br>在本机环境安装Tomcat，完成后启动服务并访问<a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a>能够看到Tomcat页面，即Tomcat成功安装。</p>
<p>###启动Jenkins服务</p>
<hr>
<p>1.在<a href="http://mirror.xmission.com/jenkins/war/" target="_blank" rel="external">http://mirror.xmission.com/jenkins/war/</a>去下载需要的war包，本该下载的是<a href="http://ftp-nyc.osuosl.org/pub/jenkins/war/1.613/jenkins.war" target="_blank" rel="external">http://ftp-nyc.osuosl.org/pub/jenkins/war/1.613/jenkins.war</a>。</p>
<hr>
<p>2.将jenkins解压后放入/Library/Tomcat/webapps下，即能正常访问<a href="http://localhost:8080/jenkins" target="_blank" rel="external">http://localhost:8080/jenkins</a>.</p>
<hr>
<p>3.可以根据需求新建Job了.</p>
<p>###Jenkins插件管理</p>
<p>####安装方式一<br>1.直接在启动的Jenkins服务下进行可视化下载安装，重新启动服务后生效。（我在采用此方式的时，有多数插件都不能成功安装，于是我采用的第二种方式）</p>
<p>####安装方式二</p>
<hr>
<p>1.Jenkins服务启动后，会自动在~/目录下生成一个.jenkins的目录，在此目录下有一个plugins的目录应该是负责插件的。</p>
<hr>
<p>2.进入该目录可以看见已经安装的部分插件了。</p>
<hr>
<p>3.进入该网址<a href="http://mirror.xmission.com/jenkins/plugins/" target="_blank" rel="external">http://mirror.xmission.com/jenkins/plugins/</a>可以直接下载需要的插件</p>
<hr>
<p>4.将下载好的插件直接放入到~/.jenkins/plugins目录下，重新启动服务即可生效（需要注意一点有些插件功能需要依赖于其它插件，所以一定要明确需要的依赖插件）</p>
<p>###iOS自动构建</p>
<hr>
<p>1.本文涉及的插件及参考文档已分享至该链接，可下载<a href="http://pan.baidu.com/s/1kTBzeYz" target="_blank" rel="external">http://pan.baidu.com/s/1kTBzeYz</a>。</p>
<hr>
<p>2.在~/.jenkins/jobs下管理新建的所有Job，可以将Job文件夹复制出来，在其它地方使用，在此帖一个已经配置好的范例（此范例是第三方管理工具CocoaPods时的配置情况）,<a href="http://pan.baidu.com/s/1dl5CU" target="_blank" rel="external">http://pan.baidu.com/s/1dl5CU</a>。</p>
<hr>
<p>3.当然可以结合Apple提供的items-service协议，在Tomcat下新建一个服务，提供一个下载页面，这样就可以完成自动构建+下载安装。</p>
<p>###其它<br>1.考虑结合版本管理</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/08/18/Jenkins环境搭建与iOS自动构建包-0/" data-id="cimd8jb6a0001tkzlfrlydsut" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-运用github-pages发布本地hexo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/05/03/运用github-pages发布本地hexo/" class="article-date">
  <time datetime="2015-05-03T14:01:31.000Z" itemprop="datePublished">2015-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/03/运用github-pages发布本地hexo/">运用github pages发布本地hexo</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#设置GitHub</p>
<ul>
<li>github帐号就不用多说了，注册吧！</li>
<li>建立与github用户名对应的仓库，仓库名为【your_user_name.github.io】（说明github.com已经废弃）。</li>
<li>添加SSH公钥到github (虽然说这里添加了，最后在hexo deploy 时还是输入的用户名、密码发布的，奇怪）</li>
</ul>
<hr>
<p>添加SSH公钥参考:github help -&gt; Generating SSH keys<br>URL:<a href="https://help.github.com/articles/generating-ssh-keys/" target="_blank" rel="external">https://help.github.com/articles/generating-ssh-keys/</a></p>
<p>####步骤1：检查本地的SSH keys<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ls -al ~/.ssh</span><br><span class="line">#List the files in your .ssh directory. if they exist.</span><br></pre></td></tr></table></figure></p>
<p>公钥与私钥情况</p>
<blockquote>
<p>id_ras  //私钥<br>id_ras.pub //公钥</p>
</blockquote>
<p>####步骤2：生成新的SSH key</p>
<p>执行下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ssh-keygen -t rsa -C &quot;your_email@example.com&quot;</span><br></pre></td></tr></table></figure></p>
<p>保存至文件（默认是保存至~/.ssh/id_rsa，可以指定存储文件路径）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter file in which to save the key (/Users/you/.ssh/id_rsa): [Press enter]</span><br></pre></td></tr></table></figure></p>
<p>设置passphrase（此处就直接回车吧）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Enter passphrase (empty for no passphrase): [Type a passphrase]</span><br><span class="line"># Enter same passphrase again: [Type passphrase again]</span><br></pre></td></tr></table></figure></p>
<p>在设置passphrase后，将打印出类似如下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Your identification has been saved in /Users/you/.ssh/id_rsa.</span><br><span class="line"># Your public key has been saved in /Users/you/.ssh/id_rsa.pub.</span><br><span class="line"># The key fingerprint is:</span><br><span class="line"># 01:0f:f4:3b:ca:85:d6:17:a1:7d:f0:68:9d:f0:a2:db your_email@example.com</span><br></pre></td></tr></table></figure></p>
<p>####步骤3：添加key至ssh-agent<br>To configure the ssh-agent program to use the SSH key you’ve generated:</p>
<ul>
<li><p>Ensure ssh-agent is enabled:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># start the ssh-agent in the background</span><br><span class="line">eval &quot;$(ssh-agent -s)&quot;</span><br><span class="line"># Agent pid 59566</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add your generated SSH key to the ssh-agent:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-add ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>####步骤4：添加SSH key 至 github 帐户</p>
<p>复制出刚才生成的公钥：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$pbcopy &lt; ~/.ssh/id_rsa.pub</span><br><span class="line"># Copies the contents of the id_rsa.pub file to your clipboard</span><br></pre></td></tr></table></figure></p>
<p>在用户设置的SSH-keys里添加。</p>
<p>####步骤5：测试连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ssh -T git@github.com</span><br><span class="line"># Attempts to ssh to GitHub</span><br></pre></td></tr></table></figure>
<hr>
<p>#设置Github Pages</p>
<ol>
<li>进入【your_user_name.github.io】仓库</li>
<li>点击仓库右侧的setting</li>
<li>根据需要修改后，点击Automatic page generator</li>
<li>根据需要修改后，点击continue to layouts</li>
<li>最后点击publish。</li>
<li>在浏览器中访问 <a href="http://your_user_name.github.io，可以看到github" target="_blank" rel="external">http://your_user_name.github.io，可以看到github</a> pages</li>
</ol>
<hr>
<p>#hexo 部暑到 github</p>
<p>先找到本地hexo目录下_config.yml文件，找到文件最后的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: http://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type:</span><br></pre></td></tr></table></figure></p>
<p>改为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: http://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: https://github.com/your_user_name/your_user_name.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure></p>
<p>#####出现的问题</p>
<ul>
<li>由于我的node是3.x版本的所以type配置为git，看之前网上文章都说是配置为github，不知为何变了<br>直接设置为type: git 后运行 hexo deploy 会出现以下错误：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR Deployer not found: git</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>参考：<a href="http://blog.163.com/gis_warrior/blog/static/19361717320153100184696/" target="_blank" rel="external">http://blog.163.com/gis_warrior/blog/static/19361717320153100184696/</a><br>运行命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>
<ul>
<li>参考其它文章都设置repository为git@github.com:your_user_name/your_user_name.github.io.git，但运行命令hexo deploy，hexo会generate, 但是最后报如下错误：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">create mode 100644 index.html</span><br><span class="line"> create mode 100644 js/script.js</span><br><span class="line"> delete mode 100644 placeholder</span><br><span class="line">Warning: Permanently added the RSA host key for IP address &apos;192.30.252.129&apos; to the list of known hosts.</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line">FATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html</span><br><span class="line">Error: Warning: Permanently added the RSA host key for IP address &apos;192.30.252.129&apos; to the list of known hosts.</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br><span class="line"></span><br><span class="line">    at ChildProcess.&lt;anonymous&gt; (/Users/computer_user_name/Desktop/Blog_hexo/node_modules/hexo-deployer-git/node_modules/hexo-util/lib/spawn.js:42:17)</span><br><span class="line">    at ChildProcess.emit (events.js:110:17)</span><br><span class="line">    at maybeClose (child_process.js:1015:16)</span><br><span class="line">    at Socket.&lt;anonymous&gt; (child_process.js:1183:11)</span><br><span class="line">    at Socket.emit (events.js:107:17)</span><br><span class="line">    at Pipe.close (net.js:485:12)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>改为：repository: <a href="https://github.com/your_user_name/your_user_name.github.io.git" target="_blank" rel="external">https://github.com/your_user_name/your_user_name.github.io.git</a> 后运行 hexo deploy 正常。<br>只是此时让我输入github的用户名和密码，只输入一次，后面deploy都不用输入。不知是否是由于本人生成SSH key时未保存至~/.ssh/id_rsa中的原因。</p>
<p>#最后测试<br>在浏览器中打开<a href="http://your_user_name.github.io，可以正常访问。" target="_blank" rel="external">http://your_user_name.github.io，可以正常访问。</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/05/03/运用github-pages发布本地hexo/" data-id="cimd8jb73000itkzlfdtlsnnt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DesignPattern/">DesignPattern</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/">Swift</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端/">后端</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/DesignPattern/" style="font-size: 10px;">DesignPattern</a> <a href="/tags/Swift/" style="font-size: 20px;">Swift</a> <a href="/tags/后端/" style="font-size: 15px;">后端</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/03/29/Bond-Chain调用/">Bond-Chain调用</a>
          </li>
        
          <li>
            <a href="/2016/03/28/Revel-run干了什么？/">Revel-run干了什么？</a>
          </li>
        
          <li>
            <a href="/2016/03/28/Bond-Observable/">Bond-Observable</a>
          </li>
        
          <li>
            <a href="/2016/03/27/Revel-新建一个应用/">Revel-new准备了什么？</a>
          </li>
        
          <li>
            <a href="/2016/03/27/后端小记开始/">后端小记开始</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 天晷<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>