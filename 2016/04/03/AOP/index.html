<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>AOP | 天晷</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在Wiki上对AOP解释，https://en.wikipedia.org/wiki/Aspect-oriented_programming：
In computing, aspect-oriented programming (AOP) is a programming paradigm that aims to increase modularity by allowing the separ">
<meta property="og:type" content="article">
<meta property="og:title" content="AOP">
<meta property="og:url" content="http://yoursite.com/2016/04/03/AOP/index.html">
<meta property="og:site_name" content="天晷">
<meta property="og:description" content="在Wiki上对AOP解释，https://en.wikipedia.org/wiki/Aspect-oriented_programming：
In computing, aspect-oriented programming (AOP) is a programming paradigm that aims to increase modularity by allowing the separ">
<meta property="og:updated_time" content="2016-04-03T14:22:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AOP">
<meta name="twitter:description" content="在Wiki上对AOP解释，https://en.wikipedia.org/wiki/Aspect-oriented_programming：
In computing, aspect-oriented programming (AOP) is a programming paradigm that aims to increase modularity by allowing the separ">
  
    <link rel="alternative" href="/atom.xml" title="天晷" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">天晷</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">脑容量有限，清理出来装灵感吧！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-AOP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/03/AOP/" class="article-date">
  <time datetime="2016-04-03T13:08:18.000Z" itemprop="datePublished">2016-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      AOP
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在Wiki上对AOP解释，<a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming：" target="_blank" rel="external">https://en.wikipedia.org/wiki/Aspect-oriented_programming：</a></p>
<p>In computing, aspect-oriented programming (AOP) is a programming paradigm that aims to increase modularity by allowing the separation of cross-cutting concerns. It does so by adding additional behavior to existing code (an advice) without modifying the code itself, instead separately specifying which code is modified via a “pointcut” specification, such as “log all function calls when the function’s name begins with ‘set’”. This allows behaviors that are not central to the business logic (such as logging) to be added to a program without cluttering the code core to the functionality. AOP forms a basis for aspect-oriented software development.</p>
<p>在不修改现有代码的基础之上，通过一个切入点添加特定的行为且不会影响原有的逻辑，例如当全部func开始调用的时候打印日志。</p>
<h2 id="NSObject"><a href="#NSObject" class="headerlink" title="NSObject"></a>NSObject</h2><h4 id="class-func-load"><a href="#class-func-load" class="headerlink" title="class func load"></a>class func load</h4><p>Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading.</p>
<p>In addition:</p>
<p>A class’s +load method is called after all of its superclasses’ +load methods.</p>
<p>A category +load method is called after the class’s own +load method.</p>
<p>Swift Class不允许overrid load方法，重写时会报错：Method ‘load()’ defines Objective-C class method ‘load’, which is not permitted by Swift.</p>
<h4 id="class-func-initialize"><a href="#class-func-initialize" class="headerlink" title="class func initialize"></a>class func initialize</h4><p>Initializes the class before it receives its first message.</p>
<p>The runtime sends initialize to each class in a program just before the class, or any class that inherits from it, is sent its first message from within the program. The runtime sends the initialize message to classes in a thread-safe manner. Superclasses receive this message before their subclasses. The superclass implementation may be called multiple times if subclasses do not implement initialize—the runtime will call the inherited implementation—or if subclasses explicitly call [super initialize]. If you want to protect yourself from being run multiple times, you can structure your implementation along these lines:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (void)initialize &#123;</span><br><span class="line">  if (self == [ClassName self]) &#123;</span><br><span class="line">    // ... do the initialization ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Because initialize is called in a thread-safe manner and the order of initialize being called on different classes is not guaranteed, it’s important to do the minimum amount of work necessary in initialize methods. Specifically, any code that takes locks that might be required by other classes in their initialize methods is liable to lead to deadlocks. Therefore you should not rely on initialize for complex initialization, and should instead limit it to straightforward, class local initialization.</p>
<ol>
<li>initialize在接收到第一条消息以前调用。</li>
<li>initialize方法调用是线程安全的。</li>
<li>父类先于子类调用；父类可能会被调用多次，当子类未实现该方法或者子类明确调用[super initialize]。</li>
<li>想确保代码只被执行一次，可用 self == [ClassName self] 判定。</li>
<li>因为是线程安全，不能保证执行顺序，不应该做过多的任务。</li>
</ol>
<h2 id="Requiring-Dynamic-Dispatch"><a href="#Requiring-Dynamic-Dispatch" class="headerlink" title="Requiring Dynamic Dispatch"></a>Requiring Dynamic Dispatch</h2><p>在Swift Interacting with Object-C 中，<a href="https://developer.apple.com/library/ios/documentation/Swift/Conceptual/BuildingCocoaApps/InteractingWithObjective-CAPIs.html#//apple_ref/doc/uid/TP40014216-CH4-ID57：" target="_blank" rel="external">https://developer.apple.com/library/ios/documentation/Swift/Conceptual/BuildingCocoaApps/InteractingWithObjective-CAPIs.html#//apple_ref/doc/uid/TP40014216-CH4-ID57：</a></p>
<p>When Swift APIs are imported by the Objective-C runtime, there are no guarantees of dynamic dispatch for properties, methods, subscripts, or initializers. The Swift compiler may still devirtualize or inline member access to optimize the performance of your code, bypassing the Objective-C runtime.</p>
<p>You can use the dynamic modifier to require that access to members be dynamically dispatched through the Objective-C runtime. Requiring dynamic dispatch is rarely necessary. However, it is necessary when using using APIs like key–value observing or the method_exchangeImplementations function in the Objective-C runtime, which dynamically replace the implementation of a method at runtime. If the Swift compiler inlined the implementation of the method or devirtualized access to it, the new implementation would not be used.</p>
<ol>
<li>Swift API 是通过 Ojbect-C 运行时导入，由于Swift编译会绕过OC运行时进行 性能优化，不能保证 properties, methods, subscripts等的动态分发。</li>
<li>设置 dynamic modifier ，实现如KVC 、 method_exchangeImplementations 等功能。</li>
</ol>
<h2 id="OC-Swift-AOP"><a href="#OC-Swift-AOP" class="headerlink" title="OC/Swift AOP"></a>OC/Swift AOP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">extension UIViewController &#123;</span><br><span class="line">    public override class func initialize() &#123;</span><br><span class="line">        super.initialize()</span><br><span class="line">        </span><br><span class="line">        struct Static &#123;</span><br><span class="line">            static var token: dispatch_once_t = 0</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        //make sure this isn&apos;t a subclass</span><br><span class="line">        if self !== UIViewController.self &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        dispatch_once(&amp;Static.token) &#123; () -&gt; Void in</span><br><span class="line">            let originalSelector = Selector(&quot;viewDidAppear:&quot;)</span><br><span class="line">            let swizzleSelector = Selector(&quot;nsh_ViewDidAppear:&quot;)</span><br><span class="line">            </span><br><span class="line">            let originalMethod = class_getInstanceMethod(self, originalSelector)</span><br><span class="line">            let swizzleMethod = class_getInstanceMethod(self, swizzleSelector)</span><br><span class="line">            </span><br><span class="line">            let didAddMethod = class_addMethod(self, originalSelector, method_getImplementation(swizzleMethod), method_getTypeEncoding(swizzleMethod))</span><br><span class="line">            </span><br><span class="line">            if didAddMethod &#123;</span><br><span class="line">                class_replaceMethod(self, swizzleSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod))</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                method_exchangeImplementations(originalMethod, swizzleMethod)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dynamic func nsh_ViewDidAppear(animated: Bool) &#123;</span><br><span class="line">        self.nsh_ViewDidAppear(animated)</span><br><span class="line">        print(&quot;viewDidAppear: \(self.description)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>Method 分成两 Selector 和 IMP 两部分。</li>
<li>当方法实现部分交换后， 用 self.nsh_ViewDidAppear(animated) 调用指向的是 之前的 ViewDidAppear 实现地址。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/03/AOP/" data-id="cimq5ag8p0001cwzlqhk51one" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pattern/">Pattern</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/04/Revel-Filter-Chain/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Revel Filter Chain
        
      </div>
    </a>
  
  
    <a href="/2016/04/03/策略模式/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">策略模式</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/">OS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Other/">Other</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pattern/">Pattern</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/">Swift</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端/">后端</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/Other/" style="font-size: 10px;">Other</a> <a href="/tags/Pattern/" style="font-size: 17.5px;">Pattern</a> <a href="/tags/Swift/" style="font-size: 20px;">Swift</a> <a href="/tags/iOS/" style="font-size: 12.5px;">iOS</a> <a href="/tags/后端/" style="font-size: 20px;">后端</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/07/EventHandler-PG/">EventHandler_PG</a>
          </li>
        
          <li>
            <a href="/2016/04/06/OC-运行时概记/">OC_运行时概记</a>
          </li>
        
          <li>
            <a href="/2016/04/06/责任链/">责任链</a>
          </li>
        
          <li>
            <a href="/2016/04/05/Unicode-UFT8-概记/">Unicode_UFT8_概记</a>
          </li>
        
          <li>
            <a href="/2016/04/04/Revel-Filter-Chain/">Revel Filter Chain</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 天晷<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>